---
title: "Ubuntuã§open-iscsi(2.0.874 @raspberry pi 4 / ubuntu 20.04)"
emoji: "ğŸ˜½"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["iscsi","ubuntu","raspberrypi","nas","fstab"]
published: true
---
# çµŒç·¯

USBã§å¤–ä»˜ã‘HDDã‚’ç¹‹ã’ã¦ã‚‚è‰¯ã‹ã£ãŸã®ã ã‘ã©ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®æ‰‹é–“å‰Šæ¸›ã¨NASã‚’æ´»ç”¨ã™ã‚‹ãŸã‚ã«iSCSIã§æ¥ç¶šã™ã‚‹ã“ã¨ã«ã€‚

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

aptã‚ˆã‚Š

```bash
sudo apt update
sudo apt install open-iscsi
```

# è¨­å®š

ã¾ãšã¯ã€ä½¿ç”¨ä¾‹ã‚’æ¤œç´¢ã—ã¤ã¤ã€[æœ¬å®¶](https://github.com/open-iscsi/open-iscsi)ã‚’èª­ã‚€ã€‚

ãƒ¡ã‚¤ãƒ³ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯

```bash
/etc/iscsi/iscsid.conf
```

ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®æ¢ç´¢ãªã©ã¯

```bash
sudo iscsiadm -m
```

ã«ç¶šãã‚³ãƒãƒ³ãƒ‰ã‚’æŠ•å…¥ã—ã¦ã„ãæ¨¡æ§˜ã€‚

æµã‚Œã¨ã—ã¦ã¯ã€

1. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ¢ç´¢ã—ã¦ç™»éŒ²ã€‚
1. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³ã€‚osãŒãƒ‡ãƒã‚¤ã‚¹ã¨ã—ã¦èªè­˜ã€‚
1. ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³è¨­å®šã€‚
1. ãƒ‡ãƒã‚¤ã‚¹ã‚’ãƒã‚¦ãƒ³ãƒˆã€‚
1. è‡ªå‹•ãƒã‚¦ãƒ³ãƒˆè¨­å®šã€‚

## 1. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ¢ç´¢ãƒ»ç™»éŒ²

ä½¿ç”¨ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰

```bash
iscsiadm -m discoverydb
# ä¸»ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³
  --type=[type] --interface=[ifaceâ€¦] --portal=[ip:port] \
  --op=[op]=[NEW | UPDATE | DELETE | NONPERSISTENT] \
  --discover
```

å®Ÿéš›ã®ã‚³ãƒãƒ³ãƒ‰ä¾‹

```bash
iscsiadm -m discoverydb -t st -p 10.55.61.110:3260 --discover
# -t == --type
# st == sendtargets
# -p == --portal

# è¦‹ã¤ã‹ã£ãŸtargetã®ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã€ç›®çš„ã®targetãŒè¦‹ã¤ã‹ã‚Œã°OK
 10.55.61.110::3260,1 iqn.2004-04.com.test:target01.38f135
```

ã“ã‚Œã§è¦‹ã¤ã‘ãŸtargetãŒå…¨ã¦ç™»éŒ²ã•ã‚Œã‚‹ã€‚

ã“ã®æ™‚ç‚¹ã§ã€/etc/iscsi/iscsid.confã‚’åŸºã«ã—ãŸã‚¿ãƒ¼ã‚²ãƒƒãƒˆå€‹åˆ¥ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒ

```bash
/etc/iscsi/nodes/iqn.2004-04.com.test:target01.38f135/10.55.61.110,3260,1/default
```

ã«ç”Ÿæˆã•ã‚Œã‚‹ã€‚
ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€iscsiadm -m discoverydb ã‚³ãƒãƒ³ãƒ‰ã§æ›´æ–°ã•ã‚Œã¦ã—ã¾ã†ã®ã§ã€ç›´æ¥ã¯å¼„ã‚‰ãªã„æ–¹ãŒè‰¯ã„ã€‚

:::message
å€‹åˆ¥ã®è¨­å®šã‚’ä¿æŒã™ã‚‹ãŸã‚ã«ã¯ã€

```bash
/etc/iscsi/nodes/iqn.2004-04.com.test:target01.38f135/10.55.61.110,3260,1/custom
```

ã®ã‚ˆã†ã«åˆ¥åã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚(iscsid.confã¯å…±é€šè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ¡ãƒ¼ã‚¸)
:::

ä½™è¨ˆãªã‚‚ã®ã¯ã€ä»¥ä¸‹ã§æ¶ˆå»ã€‚
(iscsi.serviceã®ExecStartã¯ã€iscsiadm -m node --loginall=automatic ã¨ãªã£ã¦ãŠã‚Šã€node.startup = automaticãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å…¨ã¦ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«æ¥ç¶šã—ã«ã„ãã€‚)

```bash
sudo iscsiadm -m node -T iqn.2004-04.com.test:target01.38f135 --op=delete
# -T == --targetname
```

ã‚‚ã—ã€ãƒãƒ¼ã‚¿ãƒ«ã«ã‚‚èªè¨¼ãŒå¿…è¦ãªå ´åˆã¯ã€ä»¥ä¸‹ã‚’äº‹å‰ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦è¨­å®šã€‚

```ini:/etc/iscsi/iscsid.conf
#discovery.sendtargets.auth.authmethod = CHAP
#discovery.sendtargets.auth.username = username
#discovery.sendtargets.auth.password = password
#discovery.sendtargets.auth.username_in = username_in
#discovery.sendtargets.auth.password_in = password_in
```

-------

## 2. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³

```bash
sudo iscsiadm -m node -T iqn.2004-04.com.test:target01.38f135 -l
# -l == --login
>> Logging in to [iface: default, target: iqn.2004-04.com.test:target01.38f135, portal: 10.55.61.110,3260]
>> Login to [iface: default, target: iqn.2004-04.com.test:target01.38f135, portal: 10.55.61.110,3260] successful.

# ç™»éŒ²ã—ãŸå…¨ã¦ã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹å ´åˆ
sudo iscsiadm -m node -l
```

ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹ã¨ãã¯ã€

```bash
sudo iscsiadm -m node -T iqn.2004-04.com.test:target01.38f135 --logout 
```

-------

## 3. ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³è¨­å®š

/dev/sda ã‚„ /dev/sdb ã«ã¦ãƒ‡ãƒã‚¤ã‚¹ãŒèªè­˜ã•ã‚Œã‚‹ã®ã§ã€ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’åˆ‡ã£ã¦ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‚

ä¾‹ãˆã°

```bash
parted --script /dev/sdb "mklabel gpt"
parted --script /dev/sdb "mkpart primary 0% 100%"
mkfs.ext4 /dev/sda1
```

-------

## 4. ãƒ‡ãƒã‚¤ã‚¹ã‚’ãƒã‚¦ãƒ³ãƒˆ

ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã€‚ä¾‹ãˆã°ã€

```bash
sudo mkdir /mnt/iscsi/target01
sudo mount /dev/sda /mnt/iscsi/target01
```

-------

## 5. ãƒ–ãƒ¼ãƒˆå‡¦ç†è¨­å®š

### iscsi.serviceèµ·å‹•æ™‚ã®è‡ªå‹•æ¥ç¶š

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«(iscsid.conf or å€‹åˆ¥è¨­å®š)ã§

```diff ini
- # node.startup = automatic
+ node.startup = automatic

- node.startup = manual
+ # node.startup = manual
```

### è‡ªå‹•ãƒã‚¦ãƒ³ãƒˆ

```bash
/etc/fstab
```

ã‚’ç·¨é›†ã€‚

```ini:/etc/fstab
UUID=ba4c492d-7fcc-40e6-a39a-b5532ff13357   /mnt/iscsi/target01    ext4    _netdev 0   0
```

ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã« _netdev ã‚’æŒ‡å®šã™ã‚‹ã¨ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒæ¥ç¶šã•ã‚Œã‚‹ã¾ã§ãƒã‚¦ãƒ³ãƒˆã‚’é…å»¶ã—ã¦ãã‚Œã‚‹ã€‚

mount ã‚ªãƒ—ã‚·ãƒ§ãƒ³è©³ç´°:

- <http://manpages.ubuntu.com/manpages/focal/ja/man8/mount.8.html>
- <https://man.archlinux.org/man/systemd.mount.5.en>

å› ã¿ã«ã€UUIDç¢ºèªæ–¹æ³•ã¯

```bash
sudo blkid /dev/sda1
```

# ãã®ä»–

- ã‚¤ãƒ‹ã‚·ã‚¨ãƒ¼ã‚¿ãƒ¼ã®IQNå

 ```bash
 cat /etc/iscsi/initiatorname.iscsi
 ```

- ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä¸€è¦§

 ```bash
 sudo iscsiadm -m node
 ```

- ã‚»ãƒƒã‚·ãƒ§ãƒ³(ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã®æ¥ç¶š)ä¸€è¦§

 ```bash
 sudo iscsiadm -m session -P 3
 ```

----------

## ãƒã‚¦ãƒ³ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æŒ™å‹•
- x-systemd.automountã‚’ä»˜ã‘ã‚‹ã¨ã€ä½•å‡¦ã‹ã‹ã‚‰mountãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã‚‹ã¾ã§mountãŒä¿ç•™ã•ã‚Œã‚‹ã€‚
- _netdevã ã‘ã®å ´åˆã¯ã€iscsiã®loginãŒå®Ÿè¡Œã•ã‚ŒãŸç›´å¾Œã«mountãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€‚

### _netdev,x-systemd.automount,x-systemd.device-timeout=60
```bash:/var/log/syslog
12:58:34 ubuntu systemd[1]: Listening on Open-iSCSI iscsid Socket.
12:58:34 ubuntu systemd[1]: Starting iSCSI initiator daemon (iscsid)...
12:58:34 ubuntu iscsid: iSCSI logger with pid=1789 started!
12:58:35 ubuntu systemd[1]: iscsid.service: Failed to parse PID from file /run/iscsid.pid: Invalid argument
12:58:35 ubuntu systemd[1]: Started iSCSI initiator daemon (iscsid).
12:58:35 ubuntu kernel: [   17.397665] iscsi: registered transport (tcp)
12:58:35 ubuntu iscsid: iSCSI daemon with pid=1790 started!
12:58:35 ubuntu iscsid: cannot make a connection to 10.55.61.110:3260 (-1,101)
12:58:38 ubuntu iscsid: cannot make a connection to 10.55.61.110:3260 (-1,101)
12:59:09 ubuntu iscsiadm[1768]: Logging in to [iface: default, target: iqn.2004-04.com.test:target01.38f135, portal: 10.55.61.110,3260] (multiple)
12:59:09 ubuntu iscsiadm[1768]: Login to [iface: default, target: iqn.2004-04.com.test:target01.38f135, portal: 10.55.61.110,3260] successful.
12:59:10 ubuntu iscsid: Connection1:0 to [target: iqn.2004-04.com.test:target01.38f135, portal: 10.55.61.110,3260] through [iface: default] is operational now

# ã“ã“ã§ zsh ã‹ã‚‰ /mnt/iscsi/ä»¥ä¸‹ ã«completionã®æ¢ç´¢ã‚’ã‹ã‘ã‚‹
13:01:47 ubuntu systemd[1]: mnt-iscsi-target01.automount: Got automount request for /mnt/iscsi/target01, triggered by 2169 (zsh)
13:01:47 ubuntu systemd[1]: Mounting /mnt/iscsi/target01...
13:01:47 ubuntu systemd[1]: Mounted /mnt/iscsi/target01.
```
### _netdev
```bash:/var/log/syslog
12:48:36 ubuntu systemd[1]: Listening on Open-iSCSI iscsid Socket.
12:48:36 ubuntu systemd[1]: Starting iSCSI initiator daemon (iscsid)...
12:48:36 ubuntu iscsid: iSCSI logger with pid=1786 started!
12:48:37 ubuntu systemd[1]: iscsid.service: Failed to parse PID from file /run/iscsid.pid: Invalid argument
12:48:37 ubuntu systemd[1]: Started iSCSI initiator daemon (iscsid).
12:48:37 ubuntu kernel: [   17.417340] iscsi: registered transport (tcp)
12:48:37 ubuntu iscsid: iSCSI daemon with pid=1787 started!
12:48:37 ubuntu iscsid: cannot make a connection to 10.55.61.110:3260 (-1,101)
12:48:40 ubuntu iscsid: cannot make a connection to 10.55.61.110:3260 (-1,101)
12:49:14 ubuntu iscsiadm[1765]: Logging in to [iface: default, target: iqn.2004-04.com.test:target01.38f135, portal: 10.55.61.110,3260] (multiple)
12:49:14 ubuntu iscsiadm[1765]: Login to [iface: default, target: iqn.2004-04.com.test:target01.38f135, portal: 10.55.61.110,3260] successful.
12:49:15 ubuntu systemd[1]: Mounting /mnt/iscsi/target01...
12:49:15 ubuntu iscsid: Connection1:0 to [target: iqn.2004-04.com.test:target01.38f135, portal: 10.55.61.110,3260] through [iface: default] is operational now
12:49:15 ubuntu systemd[1]: Mounted /mnt/iscsi/target01.
```
-----
## lvm2-monitor ãŒã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã§ã‚¹ã‚¿ãƒƒã‚¯ã™ã‚‹å•é¡Œ
LVMã¯ä½¿ã£ã¦ã„ãªã„ã®ã§ã€å–ã‚Šåˆãˆãš
```bash
sudo systemctl disable lvm2-monitor.service
```
---

## å‚è€ƒ

- æœ¬å®¶:
  @[card](https://github.com/open-iscsi/open-iscsi)

- ArchLinux Wiki:
<https://wiki.archlinux.jp/index.php/Open-iSCSI>

- Server-World:
<https://www.server-world.info/query?os=Ubuntu_20.04&p=iscsi&f=3>
